# Analytic Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–µ–±-—Ä–µ—Å—É—Ä—Å–æ–≤, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ Spring Boot —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ClickHouse –∏ Apache Kafka.

## –û–ø–∏—Å–∞–Ω–∏–µ

Analytic Service –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–±–æ—Ä–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫ –≤–µ–±-—Ä–µ—Å—É—Ä—Å–æ–≤. –°–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ Kafka, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ ClickHouse –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–µ—Ç—Ä–∏–∫**: –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞, —Å—Ç–∞—Ç—É—Å-–∫–æ–¥–æ–≤, —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- üîç **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ URL**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- üìà **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏
- ‚ö° **Real-time –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Kafka
- üóÑÔ∏è **–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ClickHouse –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Java 21** - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **Spring Boot 3.5.6** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Spring Kafka** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apache Kafka
- **ClickHouse** - –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **Maven** - —Å–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∫–∏
- **Lombok** - —É–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞
- **SpringDoc OpenAPI** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- **Testcontainers** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Kafka     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Analytic   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ ClickHouse  ‚îÇ
‚îÇ  Producer   ‚îÇ    ‚îÇ   Service   ‚îÇ    ‚îÇ  Database   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   REST API  ‚îÇ
                   ‚îÇ  (Reports)  ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/main/java/ru/viktorgezz/analytic_service/
‚îú‚îÄ‚îÄ controller/           # REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ AnalyticsController.java
‚îú‚îÄ‚îÄ dao/                 # –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îú‚îÄ‚îÄ ChartsDao.java
‚îÇ   ‚îú‚îÄ‚îÄ CommonMetricsDao.java
‚îÇ   ‚îî‚îÄ‚îÄ SpecificUrlMetricsDao.java
‚îú‚îÄ‚îÄ kafka/              # Kafka –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ KafkaConsumer.java
‚îÇ   ‚îî‚îÄ‚îÄ KafkaMessageConverter.java
‚îú‚îÄ‚îÄ model/              # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ charts/         # –ú–æ–¥–µ–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ Check.java      # –ú–æ–¥–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ Incident.java   # –ú–æ–¥–µ–ª—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
‚îî‚îÄ‚îÄ service/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    ‚îú‚îÄ‚îÄ impl/           # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
    ‚îî‚îÄ‚îÄ intrf/          # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
```

## API Endpoints

### GET /report
–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É URL –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `url` (String) - URL –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- `intervalHour` (int) - –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —á–∞—Å–∞—Ö

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
GET /report?url=https://example.com&intervalHour=24
```

### GET /report-common
–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—Å–µ–º URL.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
GET /report-common
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Java 21+
- Maven 3.9+
- Docker –∏ Docker Compose
- ClickHouse
- Apache Kafka

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**
```bash
git clone <repository-url>
cd analytic-service
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```env
SERVER_PORT=8085
SPRING_APPLICATION_NAME=analytic-service
CLICKHOUSE_URL=jdbc:ch://localhost:8123/default
CLICKHOUSE_USERNAME=admin
CLICKHOUSE_PASSWORD=password
CLICKHOUSE_DRIVER=com.clickhouse.jdbc.ClickHouseDriver
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_SECURITY_PROTOCOL=PLAINTEXT
KAFKA_SASL_MECHANISM=PLAIN
KAFKA_SASL_JAAS=org.apache.kafka.common.security.plain.PlainLoginModule required username="user" password="pass";
KAFKA_CONSUMER_GROUP_ID=analytic-service
KAFKA_AUTO_OFFSET_RESET=earliest
KAFKA_KEY_DESERIALIZER=org.apache.kafka.common.serialization.StringDeserializer
KAFKA_VALUE_DESERIALIZER=org.apache.kafka.common.serialization.StringDeserializer
```

3. **–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Maven:**
```bash
mvn spring-boot:run
```

### Docker

1. **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞:**
```bash
docker build -t analytic-service .
```

2. **–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose:**
```bash
docker-compose up -d
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `src/main/resources/application.yml`:

```yaml
spring:
  application:
    name: analytic-service
  datasource:
    url: jdbc:ch://203.81.208.57:8123/default
    username: admin
    password: Passw0rd
    driver-class-name: com.clickhouse.jdbc.ClickHouseDriver
  kafka:
    bootstrap-servers: 193.124.114.117:9092
    consumer:
      group-id: analytic-service
      auto-offset-reset: earliest

server:
  port: 8085
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ClickHouse –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫. –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã `checks`:

```sql
CREATE TABLE checks
(
    url String,
    timestamp DateTime('UTC'),
    success Bool,
    error Nullable(String),
    response_time Float32,
    status_code UInt16,
    content_type Nullable(String),
    content_length Nullable(UInt32),
    headers Map(String, String),
    is_https Bool,
    redirect_chain Array(String),
    security_headers Map(String, String),
    technology_stack Array(String)
)
ENGINE = MergeTree()
PARTITION BY toYYYYMMDD(timestamp)
ORDER BY (url, timestamp);
```

## Kafka Integration

–°–µ—Ä–≤–∏—Å –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Ç–æ–ø–∏–∫ `endpoint_test_results` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –≤–µ–±-—Ä–µ—Å—É—Ä—Å–æ–≤.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
mvn test
```

–¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Testcontainers –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å ClickHouse.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–µ—Ä–≤–∏—Å –≤–∫–ª—é—á–∞–µ—Ç Spring Boot Actuator –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- Health checks: `/actuator/health`
- Metrics: `/actuator/metrics`
- Swagger UI: `/swagger-ui.html`

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å –≤ –ø–∞–∫–µ—Ç–µ `model/charts/`
2. –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ –≤ `ChartsService`
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ª–æ–≥–∏–∫—É –≤ `ChartsServiceImpl`
4. –î–æ–±–∞–≤—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π DAO –º–µ—Ç–æ–¥
5. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —ç–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–µ—Ç—Ä–∏–∫–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö Check

```java
public class Check {
    private String url;                    // URL —Ä–µ—Å—É—Ä—Å–∞
    private OffsetDateTime timestamp;      // –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    private Boolean success;               // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
    private String error;                  // –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
    private Float responseTime;            // –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
    private Integer statusCode;            // HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥
    private String contentType;            // –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    private Integer contentLength;         // –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    private Map<String, String> headers;   // HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
    private Boolean isHttps;               // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS
    private List<String> redirectChain;    // –¶–µ–ø–æ—á–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
    private String sslInfo;                // SSL –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    private Map<String, String> securityHeaders; // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    private List<String> technologyStack;  // –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
}
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
