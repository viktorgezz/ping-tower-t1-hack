# Service Log Analyzer

Система для анализа логов сервисов с использованием ClickHouse и AI агента.

## Описание

Приложение предоставляет REST API для анализа логов сервисов, хранящихся в ClickHouse. AI агент анализирует последние N проверок сервиса и возвращает:

- **При наличии ошибок**: список ошибок, анализ причин и рекомендации по устранению
- **При отсутствии ошибок**: общую характеристику состояния сервиса

## Структура базы данных

### Таблица `checks`
Содержит результаты проверок сервисов:
- `url` - URL проверяемого сервиса
- `timestamp` - время проверки
- `success` - успешность проверки
- `error` - описание ошибки (если есть)
- `response_time` - время отклика
- `status_code` - HTTP статус код
- И другие поля...

### Таблица `incidents`
Содержит информацию об инцидентах.

### Таблица `daily_metrics`
Содержит дневные метрики по сервисам.

## Быстрый запуск через Docker

### **Windows:**
```bash
run.bat
```

### **Linux/Mac:**
```bash
chmod +x run.sh
./run.sh
```

### **Или вручную:**
```bash
# Сборка и запуск
docker-compose up --build -d

# Просмотр логов
docker-compose logs -f

# Остановка
docker-compose down
```

## Локальная установка (опционально)

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите приложение:
```bash
python main.py
```

**Примечание:** Система настроена для подключения к ClickHouse серверу `203.81.208.57` с пользователем `admin`.

## API Endpoints

### POST /analyze
Анализирует логи сервиса.

**Запрос:**
```json
{
    "url": "https://example.com",
    "check_count": 100
}
```

**Ответ при наличии ошибок:**
```json
{
    "url": "https://example.com",
    "analysis_type": "errors",
    "data": {
        "errors": ["Connection timeout", "SSL handshake failed"],
        "error_analysis": "Обнаружено 2 ошибки из 100 проверок (2.0% отказов). Ошибки сконцентрированы в коротком временном промежутке. Основная проблема связана с таймаутами соединений...",
        "recommendations": "Рекомендации: Увеличьте таймауты соединения и проверьте производительность сервера; Обновите SSL сертификаты..."
    }
}
```

**Ответ при отсутствии ошибок:**
```json
{
    "url": "https://example.com",
    "analysis_type": "status",
    "data": {
        "general_characteristics": "Сервис работает стабильно с высокой надежностью (99.5% успешных запросов). Производительность отличная (среднее время отклика 150мс), стабильная работа."
    }
}
```

### GET /health
Проверка здоровья сервиса и подключения к ClickHouse.

### GET /
Информация о сервисе.

## Особенности AI агента

AI агент анализирует логи по следующим критериям:

1. **Категоризация ошибок**: timeout, connection, ssl, dns, http, redirect, content
2. **Временные паттерны**: концентрация ошибок во времени
3. **Метрики производительности**: среднее время отклика, стабильность
4. **Статус коды**: распределение HTTP статус кодов

## Конфигурация

Настройки можно изменить через переменные окружения или файл `config.py`:

- `CLICKHOUSE_HOST` - хост ClickHouse (по умолчанию: localhost)
- `CLICKHOUSE_PORT` - порт ClickHouse (по умолчанию: 8123)
- `CLICKHOUSE_DATABASE` - база данных (по умолчанию: default)
- `API_HOST` - хост API (по умолчанию: 0.0.0.0)
- `API_PORT` - порт API (по умолчанию: 8000)
- `DEFAULT_CHECK_COUNT` - количество проверок по умолчанию (по умолчанию: 100)
- `MAX_CHECK_COUNT` - максимальное количество проверок (по умолчанию: 1000)
